{% extends 'index.html' %} {% block title %}Breeding Program{% endblock %} {%
block content %}
<h1>Breeding Program</h1>
<span id="uid"></span>
<div id="details">Register breed program</div>

<script>
  let focusedField = "uid"; // Track the focused input field
  let lastUID = ""; // Store the last UID to avoid unnecessary updates

  // Set the currently focused field when an input is clicked
  function setFocusedField(field) {
    focusedField = field;
  }

  async function fetchUID() {
    const response = await fetch("/latest_uid");
    const data = await response.json();
    const uid = data.uid || "No UID scanned";

    // Only update the field if a new UID is scanned and it hasn't been set before
    if (uid !== "No UID scanned" && uid !== lastUID) {
      document.getElementById(focusedField).value = uid;
      lastUID = uid; // Update the lastUID to avoid duplicate updates

      // Fetch and display goat details only for the first UID field
      if (focusedField === "uid") {
        const detailsResponse = await fetch(`/uid_details/${uid}`);
        const details = await detailsResponse.json();
        displayDetails(details);
      }
    }
  }

  function displayDetails(details) {
    if (details) {
      document.getElementById("details").innerHTML = `
        <form id="goatForm" action="/add_breeding" method="POST">
          <div>
            <label for="uid">UID</label>
            <input type="text" id="uid" name="uid" onclick="setFocusedField('uid')" value="${details.uid}" readonly>
          </div>
          <div>
            <label for="uid2">Partner UID</label>
            <input type="text" id="partner_uid" name="partner_uid" onclick="setFocusedField('partner_uid')" value="${details.partner_uid}" readonly>
          </div>
          <div>
            <label for="program_date">Program Date</label>
            <input type="datetime-local" id="program_date" name="program_date"
            value=${new Date(details.program_date).toISOString().slice(0, 16)}>
          </div>
          <div>
            <label for="pregnancy_check_date">Pregnancy Check Date</label>
            <input type="datetime-local" id="pregnancy_check_date" name="pregnancy_check_date"
            value=${new Date(details.pregnancy_check_date).toISOString().slice(0, 16)} readonly>
          </div>
          <div>
            <label for="expected_birth_date">Expected Birth Date</label>
            <input type="datetime-local" id="expected_birth_date" name="expected_birth_date"
            value=${new Date(details.expected_birth_date).toISOString().slice(0, 16)} readonly>
          </div>
          <div>
            <label for="breeding_method">Breeding Method</label>
            <input type="text" id="breeding_method" name="breeding_method" placeholder="AI(Artificial insemination) / Hand mating / Pen mating">
          </div>
          <div>
            <button type="submit">Register</button>
          </div>
          <div class="view-back-container">
            <a href="{{url_for('view_breeding')}}" class="link-view-back">View</a>
          </div>
        </form>`;

      // Set event listener for program date change
      document.getElementById('program_date').addEventListener('change', calculateDates);
    } else {
      document.getElementById("details").innerHTML = "<p>No details available</p>";
    }
  }

  // Fetch UID every 2 seconds (2000ms) and insert it into the focused input
  setInterval(fetchUID, 1000);

  function calculateDates() {
    const programDateInput = document.getElementById('program_date').value;

    if (programDateInput) {
      const programDate = new Date(programDateInput);

      // Calculate pregnancy check date after 30 days
      const pregnancyCheckDate = new Date(programDate);
      pregnancyCheckDate.setDate(pregnancyCheckDate.getDate() + 30);
      const formattedPregnancyDate = pregnancyCheckDate.toISOString().slice(0, 16);

      // Calculate expected birth date after 150 days
      const expectedBirthDate = new Date(programDate);
      expectedBirthDate.setDate(expectedBirthDate.getDate() + 150);
      const formattedBirthDate = expectedBirthDate.toISOString().slice(0, 16);

      // Update the input fields with calculated dates
      document.getElementById('pregnancy_check_date').value = formattedPregnancyDate;
      document.getElementById('expected_birth_date').value = formattedBirthDate;
    } else {
      // Clear the pregnancy and expected birth date fields if program date is empty
      document.getElementById('pregnancy_check_date').value = '';
      document.getElementById('expected_birth_date').value = '';
    }
  }
</script>


{% endblock %}
